city_index <- starts_with(match = "City", vars = colnames(df))
time_index <- starts_with(match = "Pro", vars = colnames(df))
if(colnames(df)[time_index] == "ProcessIdP1"){
colnames(df)[time_index] <- "ProcessIdP3"
}
if(colnames(df)[city_index] == "CityNameTr"){
colnames(df)[city_index] <- "CityNameEng"
}
df <- df %>%
janitor::clean_names() %>%
rename(true_value = process_id,
prediction = majority) %>%
select(id, region_name_eng, city_name_eng, true_value, prediction)
df$id = as.numeric(df$id)
df$true_value = as.numeric(df$true_value)
df$prediction = as.numeric(df$prediction)
df <- df %>%
mutate(true_value = case_when(true_value == 41 ~ "Wheat",
true_value == 12 ~ "Sunflower",
true_value == 13 ~ "Pepper",
true_value == 14 ~ "Rice",
true_value == 15 ~ "Tomato",
true_value == 16 ~ "Watermelon",
true_value == 17 ~ "Melon",
true_value == 18 ~ "Corn",
true_value == 19 ~ "Sugarbeet",
true_value == 21 ~ "Alfalfa",
true_value == 24 ~ "Cotton",
true_value == 25 ~ "Bean",
true_value == 28 ~ "Potato",
true_value == 32 ~ "Vegetation",
true_value == 51 ~ "Canola",
true_value == 52 ~ "Onion",
true_value == 56 ~ "Lentil",
true_value == 58 ~ "Chickpea",
true_value == 62 ~ "Squash",
true_value == 66 ~ "Tobacco",
true_value == 72 ~ "Vineyard",
true_value == 96 ~ "Orchard",
true_value == 97 ~ "NotField",
true_value == 98 ~ "Other",
true_value == 99 ~ "Agricultural_Soil")) %>%
mutate(prediction = case_when(prediction == 41 ~ "Wheat",
prediction == 12 ~ "Sunflower",
prediction == 13 ~ "Pepper",
prediction == 14 ~ "Rice",
prediction == 15 ~ "Tomato",
prediction == 16 ~ "Watermelon",
prediction == 17 ~ "Melon",
prediction == 18 ~ "Corn",
prediction == 19 ~ "Sugarbeet",
prediction == 21 ~ "Alfalfa",
prediction == 24 ~ "Cotton",
prediction == 25 ~ "Bean",
prediction == 28 ~ "Potato",
prediction == 32 ~ "Vegetation",
prediction == 51 ~ "Canola",
prediction == 52 ~ "Onion",
prediction == 56 ~ "Lentil",
prediction == 58 ~ "Chickpea",
prediction == 62 ~ "Squash",
prediction == 66 ~ "Tobacco",
prediction == 72 ~ "Vineyard",
prediction == 96 ~ "Orchard",
prediction == 97 ~ "NotField",
prediction == 98 ~ "Other",
prediction == 99 ~ "Agricultural_Soil"))
save(list = "df", file = "~crop-classification-accuracy/processed_data/df.RDS")
save(list = "df", file = "~/crop-classification-accuracy/processed_data/df.RDS")
rm(list = ls())
library(flexdashboard)
library(tidyverse)
library(ggplot2)
library(plotly)
library(ggthemes)
library(rstudioapi)
load("~/crop-classification-accuracy/processed_data/df.RDS")
acc_df <- tibble(city = unique_crops, sensitivity = NA, precision = NA)
unique_cities = df$city_name_eng %>% unique
unique_crops = df$prediction %>% unique
acc_df <- tibble(city = unique_crops, sensitivity = NA, precision = NA)
acc_df$precision = map_dbl(1:length(unique_crops), .f = function(i){
x <- df %>%
filter(prediction == unique_crops[i])
true_preds <- x %>%
filter(prediction == true_value) %>%
nrow()
n <- nrow(x)
acc <- true_preds/n
acc})
acc_df$sensitivity = map_dbl(1:length(unique_crops), .f = function(i){
x <- df %>%
filter(true_value == unique_crops[i])
true_preds <- x %>%
filter(prediction == true_value) %>%
nrow()
n <- nrow(x)
acc <- true_preds/n
acc})
acc_df <- acc_df %>%
mutate(f_score = (2*precision*sensitivity)/(precision+sensitivity))
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
filter(high == "High Accuracy") %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = FALSE, alpha = 1, width = 0.4)+
theme_pander()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
#facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
filter(high == "High Accuracy") %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = FALSE, alpha = 1, width = 0.4, show.legend = FALSE)+
theme_pander()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
#facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
filter(high == "High Accuracy") %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_pander()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
#facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
filter(high == "High Accuracy") %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_pander()+
#coord_flip()+
scale_y_continuous(label = scales::percent)+
#facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
filter(high == "High Accuracy") %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_pander()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_pander()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_calc()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_clean()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_bw()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_base()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_par()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_economist_white()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
p1 <- acc_df %>%
mutate(high = ifelse(f_score > 0.75, "High Accuracy", "Low Accuracy")) %>%
ggplot(aes(x = reorder(city, f_score), y = f_score, fill = high))+
geom_col(show.legend = NULL, alpha = 1, width = 0.4)+
theme_minimal()+
coord_flip()+
scale_y_continuous(label = scales::percent)+
facet_wrap(~high, scales = "free")+
scale_fill_tableau()+
labs(y = "Accuracy",
x = "",
title = "Prediction Accuracy (F-Score)")
ggplotly(p1)
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
rm(list = ls())
library(tidyverse)
library(ggplot2)
library(plotly)
library(ggthemes)
library(rstudioapi)
library(caret)
uniqe_true <- df$true_value %>% unique
library(caret)
uniqe_true <- df$true_value %>% unique
load("~/crop-classification-accuracy/processed_data/df.RDS")
uniqe_true <- df$true_value %>% unique
unique_pred <- df$prediction %>% unique
unique_all <- c(uniqe_true, unique_pred) %>% unique
res <- caret::confusionMatrix(factor(df$true_value, unique_all),
factor(df$prediction, unique_all))
res
res$overall
res$overall[1]
accuracy <- as.numeric(res$overall[1])
accuracy <- round(as.numeric(res$overall[1]),1)
valueBox(accuracy)
confMatPlot = function(confMat, titleMy, shouldPlot = T) {
#' Function for plotting confusion matrice
#'
#' @param confMat: confusion matrix with counts, ie integers.
#' Fractions won't work
#' @param titleMy: String containing plot title
#' @return Nothing: It only plots
## Prepare data
x.orig = confMat; rm(confMat)  # Lazy conversion to function internal variable name
n = nrow(x.orig)  # conf mat is square by definition, so nrow(x) == ncol(x)
opar <- par(mar = c(5.1, 8, 3, 2))
x <- x.orig
x <- log(x + 0.5)  # x<1 -> x<0 ,  x>=1 -> x>0
x[x < 0] <- NA
diag(x) <- -diag(x)  # change sign to give diagonal different color
## Plot confusion matrix
image(1:n, 1:n,  # grid of coloured boxes
# matrix giving color values for the boxes
# t() and [,ncol(x):1] since image puts [1,1] in bottom left by default
-t(x)[, n:1],
# ylab added later to avoid overlap with tick labels
xlab = 'Actual', ylab = '',
col = colorRampPalette(c("darkorange3", "white", "steelblue"),
bias = 1.65)(100),
xaxt = 'n', yaxt = 'n'
)
# Plot counts
text(rep(1:n, each = n), rep(n:1, times = n),
labels = sub('^0$', '', round(c(x.orig), 0)))
# Axis ticks but no lables
axis(1, at = 1:n, labels = rep("", n), cex.axis = 0.8)
axis(2, at = n:1, labels = rep("", n), cex.axis = 0.8)
# Tilted axis lables
text(cex = 0.8, x = (1:n), y = -0.1, colnames(x), xpd = T, srt = 30, adj = 1)
text(cex = 0.8, y = (n:1), x = +0.1, colnames(x), xpd = T, srt = 30, adj = 1)
title(main = titleMy)
title(ylab = 'Predicted', line = 6)
# Grid and box
abline(h = 0:n + 0.5, col = 'gray')
abline(v = 0:n + 0.5, col = 'gray')
box(lwd = 1, col = 'gray')
par(opar)
}
uniqe_true <- df$true_value %>% unique
unique_pred <- df$prediction %>% unique
unique_all <- c(uniqe_true, unique_pred) %>% unique
unique_all <- unique_all[1:22]
df_factor <- df %>%
filter(!true_value %in% c("Agricultural_Soil", "Other", "NotField")) %>%
filter(!prediction %in% c("Agricultural_Soil", "Other", "NotField")) %>%
mutate(true_value = factor(true_value, unique_all)) %>%
mutate(prediction = factor(prediction, unique_all))
confMatPlot(yardstick::conf_mat(df_factor, true_value, prediction))
confMatPlot(yardstick::conf_mat(df_factor, true_value, prediction), titleMy = "Plot")
yardstick::conf_mat(df_factor, true_value, prediction)
autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap") +
scale_fill_gradient()
autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap") +
scale_fill_continuous_tableau()
autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_brewer()
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_continuous_tableau()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_color_continuous_tableau()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_continuous()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_continuous_tableau()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction))+
scale_fill_continuous_tableau()
ggplotly(p2)
autoplot(yardstick::conf_mat(df_factor, true_value, prediction))+
scale_fill_continuous_tableau()
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_continuous_tableau()
ggplotly(p2)
res$table
table(res$table)
res$overall
kappa <- res$overall[2]
yardstick::f_meas_vec(df_factor$true_value, df_factor$prediction)
res$overall[1]
as.numeric(res$overall[1]) * 100
yardstick::accuracy_vec(df_factor$true_value, df_factor$prediction)
yardstick::bal_accuracy_vec(df_factor$true_value, df_factor$prediction)
yardstick::kap_vec(df_factor$true_value, df_factor$prediction)
yardstick::sens_vec(df_factor$true_value, df_factor$prediction)
yardstick::specificity_vec(df_factor$true_value, df_factor$prediction)
0.8051424 + 0.9933144
(0.8051424 + 0.9933144)/2
library(caret)
uniqe_true <- df$true_value %>% unique
unique_pred <- df$prediction %>% unique
unique_all <- c(uniqe_true, unique_pred) %>% unique
unique_all <- unique_all[1:22]
df_factor <- df %>%
filter(!true_value %in% c("Agricultural_Soil", "Other", "NotField")) %>%
filter(!prediction %in% c("Agricultural_Soil", "Other", "NotField")) %>%
mutate(true_value = factor(true_value, unique_all)) %>%
mutate(prediction = factor(prediction, unique_all))
res <- caret::confusionMatrix(factor(df$true_value, unique_all),
factor(df$prediction, unique_all))
accuracy <- round(as.numeric(res$overall[1]) * 100,1)
accuracy
library(caret)
uniqe_true <- df$true_value %>% unique
unique_pred <- df$prediction %>% unique
unique_all <- c(uniqe_true, unique_pred) %>% unique
df_factor <- df %>%
#filter(!true_value %in% c("Agricultural_Soil", "Other", "NotField")) %>%
#filter(!prediction %in% c("Agricultural_Soil", "Other", "NotField")) %>%
mutate(true_value = factor(true_value, unique_all)) %>%
mutate(prediction = factor(prediction, unique_all))
res <- caret::confusionMatrix(factor(df$true_value, unique_all),
factor(df$prediction, unique_all))
accuracy <- round(as.numeric(res$overall[1]) * 100,1)
accuracy
yardstick::sensitivity(df_factor$true_value, df_factor$prediction)
yardstick::sensitivity_vec(df_factor$true_value, df_factor$prediction)
yardstick::precision_vec_vec(df_factor$true_value, df_factor$prediction)
yardstick::precision_vec(df_factor$true_value, df_factor$prediction)
library(caret)
uniqe_true <- df$true_value %>% unique
unique_pred <- df$prediction %>% unique
unique_all <- c(uniqe_true, unique_pred) %>% unique
unique_all <- unique_all[1:22]
df_factor <- df %>%
filter(!true_value %in% c("Agricultural_Soil", "Other", "NotField")) %>%
filter(!prediction %in% c("Agricultural_Soil", "Other", "NotField")) %>%
mutate(true_value = factor(true_value, unique_all)) %>%
mutate(prediction = factor(prediction, unique_all))
yardstick::precision_vec(df_factor$true_value, df_factor$prediction)
yardstick::precision_vec(df_factor$true_value, df_factor$prediction)
yardstick::f_meas_vec(df_factor$true_value, df_factor$prediction)
x = yardstick::precision_vec(df_factor$true_value, df_factor$prediction)
x = yardstick::sensitivity_vec(df_factor$true_value, df_factor$prediction)
y = yardstick::precision_vec(df_factor$true_value, df_factor$prediction)
2 * (x*y/(x+y))
y = yardstick::precision_vec(df_factor$true_value, df_factor$prediction, estimator = "macro_weghted")
y = yardstick::precision_vec(df_factor$true_value, df_factor$prediction, estimator = "macro_weighted")
y
yardstick::f_meas_vec(df_factor$true_value, df_factor$prediction, estimator = "macro_weighted")
yardstick::f_meas_vec(df_factor$true_value, df_factor$prediction, estimator = "micro")
library(caret)
uniqe_true <- df$true_value %>% unique
unique_pred <- df$prediction %>% unique
unique_all <- c(uniqe_true, unique_pred) %>% unique
unique_all <- unique_all[1:22]
df_factor <- df %>%
filter(!true_value %in% c("Agricultural_Soil", "Other", "NotField")) %>%
filter(!prediction %in% c("Agricultural_Soil", "Other", "NotField")) %>%
mutate(true_value = factor(true_value, unique_all)) %>%
mutate(prediction = factor(prediction, unique_all))
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_continuous()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_gradient()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_gradient_tableau()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_gradient2_tableau()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_gradientn()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_grey()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_canva()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_gradient()
ggplotly(p2)
p2 <- autoplot(yardstick::conf_mat(df_factor, true_value, prediction), type = "heatmap")+
scale_fill_continuous_tableau()
ggplotly(p2)
library(caret)
uniqe_true <- df$true_value %>% unique
unique_pred <- df$prediction %>% unique
unique_all <- c(uniqe_true, unique_pred) %>% unique
unique_all <- unique_all[1:22]
df_factor <- df %>%
filter(!true_value %in% c("Agricultural_Soil", "Other", "NotField")) %>%
filter(!prediction %in% c("Agricultural_Soil", "Other", "NotField")) %>%
mutate(true_value = factor(true_value, unique_all)) %>%
mutate(prediction = factor(prediction, unique_all))
conf_matrix <- conf_mat(df_factor, true_value, prediction)
conf_matrix <- yardstick::conf_mat(df_factor, true_value, prediction)
conf_matrix
install.packages("cvms")
conf_matrix <- cvms::confusion_matrix(targets = df_factor$true_value, predictions = df$prediction)
conf_matrix <- cvms::confusion_matrix(targets = df_factor$true_value, predictions = df_factor$prediction)
p2 <- plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]],
add_sums = TRUE)
p2 <- cvms::plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]],
add_sums = TRUE)
p2 <- cvms::plot_confusion_matrix(conf_matrix$`Confusion Matrix`[[1]],
add_sums = TRUE)
ggplotly(p2)
cvms::plot_confusion_matrix(conf_matrix$`Confusion Matrix`[[1]],
add_sums = TRUE)
cvms::plot_confusion_matrix(conf_matrix$`Confusion Matrix`[[1]])
conf_matrix
